<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>記憶の桜島</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        body {
            background: #000;
            font-family: sans-serif;
        }
        #canvas {
            display: block;
            width: 100vw;
            height: 100vh;
        }
        #permission-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        #permission-overlay.hidden {
            display: none;
        }
        #permission-btn {
            padding: 10px 20px;
            font-size: 18px;
            background: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        #permission-text {
            color: #fff;
            margin-bottom: 30px;
            text-align: center;
            padding: 0 20px;
            font-size: 14px;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div id="permission-overlay">
        <div id="permission-text">
            歩くと、桜島は灰になり、<br>
            立ち止まると、いつもの桜島に戻ります。<br><br>
            モーションセンサーへのアクセスを<br>許可してください
        </div>
        <button id="permission-btn">開始</button>
    </div>
    <canvas id="canvas"></canvas>

    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
        }
    }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { PLYLoader } from 'three/addons/loaders/PLYLoader.js';

        // ========================================
        // 設定：外部点群ファイルのパス
        // ========================================
        // null の場合は、デフォルトの円錐形の山を生成
        // PLYファイルを使う場合は、ファイルパスを指定
        const POINT_CLOUD_FILE = null; // 例: './sakurajima.ply'

        // ========================================
        // グローバル変数
        // ========================================
        let scene, camera, renderer, particles, controls;
        let isWalking = false;
        let isStill = true;
        let stillTimer = 0;
        const STILL_THRESHOLD = 3000; // 3秒

        // センサー関連
        let lastAccel = { x: 0, y: 0, z: 0 };
        const ACCEL_THRESHOLD = 0.3; // 歩行判定の閾値（調整可能）

        // パーティクル設定
        const PARTICLE_COUNT = 30000;
        const originalPositions = [];
        const velocities = [];
        const particleStates = []; // 各パーティクルの状態（0: 山の一部, 1: 放出中）
        const RELEASE_RATE = 80; // 1フレームあたりランダムに放出される点の数（噴火は激しく）

        // ========================================
        // three.js初期化
        // ========================================
        function init() {
            // シーン
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0a0a0a);

            // カメラ
            camera = new THREE.PerspectiveCamera(
                60,
                window.innerWidth / window.innerHeight,
                0.1,
                1000
            );
            camera.position.set(0, 1.5, 8);
            camera.lookAt(0, 1, 0);

            // レンダラー
            const canvas = document.getElementById('canvas');
            renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));

            // 点群生成
            if (POINT_CLOUD_FILE) {
                loadPointCloudFromFile(POINT_CLOUD_FILE);
            } else {
                createMountainPoints();
            }

            // OrbitControls（3D回転操作）
            controls = new OrbitControls(camera, canvas);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.enableZoom = true;
            controls.enablePan = false;

            // リサイズ対応
            window.addEventListener('resize', onResize);
        }

        // ========================================
        // 外部ファイルから点群を読み込み
        // ========================================
        function loadPointCloudFromFile(filePath) {
            const loader = new PLYLoader();
            loader.load(
                filePath,
                function (geometry) {
                    // ジオメトリから位置情報を取得
                    const positions = geometry.getAttribute('position');
                    const count = positions.count;

                    console.log(`Loaded ${count} points from ${filePath}`);

                    // オリジナル位置を保存
                    for (let i = 0; i < count; i++) {
                        const x = positions.getX(i);
                        const y = positions.getY(i);
                        const z = positions.getZ(i);
                        originalPositions.push({ x, y, z });
                        velocities.push({ x: 0, y: 0, z: 0 });
                        particleStates.push(0);
                    }

                    // マテリアル（火山灰イメージ）
                    const material = new THREE.PointsMaterial({
                        color: 0xffffff,
                        size: 0.04,
                        transparent: true,
                        opacity: 0.9,
                        depthWrite: false,
                        blending: THREE.AdditiveBlending
                    });

                    particles = new THREE.Points(geometry, material);
                    scene.add(particles);
                },
                function (xhr) {
                    console.log((xhr.loaded / xhr.total * 100) + '% loaded');
                },
                function (error) {
                    console.error('Error loading point cloud:', error);
                    // エラー時はデフォルトの山を生成
                    createMountainPoints();
                }
            );
        }

        // ========================================
        // 山型の点群生成（円錐形）- デフォルト
        // ========================================
        function createMountainPoints() {
            const geometry = new THREE.BufferGeometry();
            const positions = new Float32Array(PARTICLE_COUNT * 3);

            for (let i = 0; i < PARTICLE_COUNT; i++) {
                // 円錐形の山を生成
                const t = Math.random();
                const height = Math.random() * 4; // 高さ 0-4
                const radius = (1 - height / 4) * 2.5; // 下が広く上が狭い

                const theta = Math.random() * Math.PI * 2;
                const r = Math.sqrt(Math.random()) * radius;

                const x = r * Math.cos(theta);
                const y = height;
                const z = r * Math.sin(theta);

                positions[i * 3] = x;
                positions[i * 3 + 1] = y;
                positions[i * 3 + 2] = z;

                // オリジナル位置を保存
                originalPositions.push({ x, y, z });

                // 速度初期化
                velocities.push({ x: 0, y: 0, z: 0 });

                // 状態初期化（0: 山の一部）
                particleStates.push(0);
            }

            geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));

            // マテリアル（火山灰イメージ）
            const material = new THREE.PointsMaterial({
                color: 0xffffff,
                size: 0.04,
                transparent: true,
                opacity: 0.9,
                depthWrite: false,
                blending: THREE.AdditiveBlending
            });

            particles = new THREE.Points(geometry, material);
            scene.add(particles);
        }

        // ========================================
        // センサー初期化
        // ========================================
        function initSensors() {
            if (typeof DeviceMotionEvent !== 'undefined') {
                window.addEventListener('devicemotion', handleMotion);
            } else {
                console.warn('DeviceMotionEvent not supported');
            }
        }

        // ========================================
        // 加速度センサー処理
        // ========================================
        function handleMotion(event) {
            if (!event.accelerationIncludingGravity) return;

            const accel = event.accelerationIncludingGravity;
            const dx = Math.abs(accel.x - lastAccel.x);
            const dy = Math.abs(accel.y - lastAccel.y);
            const dz = Math.abs(accel.z - lastAccel.z);
            const totalChange = dx + dy + dz;

            // 歩行判定
            if (totalChange > ACCEL_THRESHOLD) {
                isWalking = true;
                isStill = false;
                stillTimer = 0;
            } else {
                isWalking = false;
                stillTimer += 16; // 約60fps想定

                // 3秒以上静止したらstill状態
                if (stillTimer >= STILL_THRESHOLD) {
                    isStill = true;
                }
            }

            lastAccel = { x: accel.x, y: accel.y, z: accel.z };
        }

        // ========================================
        // パーティクル更新
        // ========================================
        function updateParticles() {
            if (!particles || !particles.geometry) return;

            const positionsAttr = particles.geometry.getAttribute('position');
            if (!positionsAttr) return;

            const positions = positionsAttr.array;
            const particleCount = originalPositions.length;

            // 歩行中：ランダムに点群を放出状態にする
            if (isWalking) {
                // 毎フレーム、ランダムに数点を放出状態に変更
                const releaseCount = Math.min(RELEASE_RATE, particleCount);
                for (let j = 0; j < releaseCount; j++) {
                    const randomIndex = Math.floor(Math.random() * particleCount);
                    if (particleStates[randomIndex] === 0) {
                        particleStates[randomIndex] = 1; // 放出状態にする

                        // 放出時の初速度を与える（噴火で上方向へ舞い上がる）
                        const vel = velocities[randomIndex];
                        const i3 = randomIndex * 3;

                        // 現在位置を取得
                        const px = positions[i3];
                        const py = positions[i3 + 1];
                        const pz = positions[i3 + 2];

                        // 上方向メインで、少し横方向にもランダムに散る（火山灰イメージ）
                        const upwardPower = 0.08 + Math.random() * 0.05; // 強めの上昇
                        vel.y = upwardPower;
                        vel.x = (Math.random() - 0.5) * 0.03; // 横方向の散り
                        vel.z = (Math.random() - 0.5) * 0.03;
                    }
                }
            } else if (isStill) {
                // 静止中：すべての点を山の一部に戻す
                for (let i = 0; i < particleCount; i++) {
                    particleStates[i] = 0;
                }
            }

            // 各パーティクルの位置更新
            for (let i = 0; i < particleCount; i++) {
                const i3 = i * 3;
                const orig = originalPositions[i];
                const vel = velocities[i];
                const state = particleStates[i];

                if (state === 1) {
                    // 放出中：火山灰のように浮遊しながら横に流れる
                    // ランダムに揺らぎながら漂う
                    vel.x += (Math.random() - 0.5) * 0.02;
                    vel.y += (Math.random() - 0.5) * 0.02; // 上下にもゆらぎ
                    vel.z += (Math.random() - 0.5) * 0.02;

                    // 速度減衰（徐々に静止する）
                    vel.x *= 0.96;
                    vel.y *= 0.96;
                    vel.z *= 0.96;
                } else {
                    // 山の一部：元の位置へ戻る／維持する
                    const dx = orig.x - positions[i3];
                    const dy = orig.y - positions[i3 + 1];
                    const dz = orig.z - positions[i3 + 2];

                    vel.x = dx * 0.05;
                    vel.y = dy * 0.05;
                    vel.z = dz * 0.05;
                }

                // 位置更新
                positions[i3] += vel.x;
                positions[i3 + 1] += vel.y;
                positions[i3 + 2] += vel.z;
            }

            positionsAttr.needsUpdate = true;
        }

        // ========================================
        // アニメーションループ
        // ========================================
        function animate() {
            requestAnimationFrame(animate);
            controls.update(); // OrbitControlsの更新
            updateParticles();
            renderer.render(scene, camera);
        }

        // ========================================
        // リサイズ対応
        // ========================================
        function onResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // ========================================
        // 許可ボタン処理
        // ========================================
        document.getElementById('permission-btn').addEventListener('click', async () => {
            // iOS 13+ のDeviceMotionEvent許可
            if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                try {
                    const permission = await DeviceMotionEvent.requestPermission();
                    if (permission === 'granted') {
                        initSensors();
                    }
                } catch (error) {
                    console.error('Permission denied', error);
                }
            } else {
                // Android等
                initSensors();
            }

            // オーバーレイを非表示
            document.getElementById('permission-overlay').classList.add('hidden');
        });

        // ========================================
        // 起動
        // ========================================
        init();
        animate();
    </script>
</body>
</html>
